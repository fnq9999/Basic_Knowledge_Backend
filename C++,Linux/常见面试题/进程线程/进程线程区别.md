Linux下进程线程区别
==================
### 定义
- 对于有线程系统：
    - 进程是资源分配的独立单位
    - 线程是资源调度的独立单位
- 对于无线程系统：
    - 进程是资源调度、分配的独立单位
### 创建
- 进程和线程的创建都是通过clone(2)来实现的
    - fork()->clone(SIGCHLD,0)
    - pthread_create()->clone(CLONE_VM|CLONE_FS|CLONE_FILES|CLONE_SIGHAND,0)
    - vfork()->clone(CLONE_VFORK|CLONE_VM|SIGCHLD,0)
    
`SIGCHLD 意思是要求在子进程创建时必须注册SIGCHLD信号。当子进程退出时，系统会给父进程发送SIGCHLD信号，对其进行处理，避免子进程变成僵尸进程`

`CLONE_VFORK 使子进程创建以后优先于父进程运行（父进程此时被阻塞睡眠），直到子进程终结（terminate）或发出一个fatal信号或调用execve`

`线程共享虚拟地址空间，文件系统信息，打开的文件，信号处理函数和被阻断的信号`
    
[Linux进程创建三——fork、vfork、clone、kernel_thread](https://blog.csdn.net/yin262/article/details/54587464)
    
### 共享的资源
- 进程
    - 私有
        - 地址空间，全局变量，堆，栈，寄存器
    - 共享
        - 内核空间
        - 代码段被共享（关于共享库的知识）[how is a shared library file called by two different processes in Linux?](https://stackoverrun.com/cn/q/1046109)
        - 进程目录（父子进程）
        - 公共数据（共享内存办法：mmap等）
- 线程
    - 私有
        - 线程栈，寄存器
    - 共享
        - 地址空间，堆，全局变量，静态变量 

### 进程栈和线程栈
- 进程栈
    - 虚拟地址空间当中user space 的stack区
- 线程栈
    - 从进程的地址空间当中map出来的一块区域，大小固定，不支持动态增长
    - 是同一个进程的所有线程生成的时候浅拷贝生成者的 task_struct 的很多字段，其中包括所有的 vma，如果愿意，其它线程也还是可以访问到的，于是一定要注意。
[Linux 中的各种栈：进程栈 线程栈 内核栈 中断栈](https://blog.csdn.net/yangkuanqaz85988/article/details/52403726)
### 上下文切换
- 进程上下文切换：
    - [CPU上下文切换](https://zhuanlan.zhihu.com/p/99923968)(系统调用是发生的就是CPU上下文切换)
    - 内核栈信息
    - 虚拟内存替换(还有TLB刷新)、栈、全局变量等用户空间资源
    - 如果使用ASID的TLB，进程切换时，不需要刷新TLB
- 线程上下文切换
    - 进程切换比线程切换多了TLB的刷新，之所以说进程切换的开销比线程切换大，涉及到TLB失效--->页表失效--->效率降低
[](https://cloud.tencent.com/developer/article/1492104)
### 进程组和线程组
[linux内核——进程，轻量级进程，线程，线程组](https://www.cnblogs.com/ISeeIC/p/3617630.html)<br>    
- 进程组
    - 是用来方便管理进程的，一个进程只能属于一个进程组，只要进程组当中的一个进程没有结束，那么整个进程也没有结束
- 线程组
    - 对线程getpid得到的并不是线程本身的pid，而是tgid
    - 一个tgid就是一个线程组
    
<img src="https://images0.cnblogs.com/i/615801/201403/221504410064366.jpg" width="40%"/>

### 通信
-  进程通信
    - 管道（pipe）,流管道(s_pipe)和有名管道（FIFO）
    - 信号（signal）
    - 消息队列
    - 共享内存（mmap等）
    - 信号
    - 信号量
    - 套接字（socket)
    
- 线程同步/通信：线程的通信主要是为了线程之间的同步，所以没有复杂的数据交换通信机制
    - 锁机制
        - 互斥锁+条件变量
        - 读写锁
    - 信号量机制
    - 信号机制
    
### 数据安全 （并发上）
- 进程同步
    - 共享内存上加互斥锁和条件变量
    - 读写锁，记录锁，信号量，屏障
- 线程同步 
    - 互斥量，条件变量，自旋锁，屏障，信号量，读写锁
- 区别在于锁的数据的位置，放在一个进程内的数据，还是数据

[linux线程同步和进程同步的区别](https://blog.csdn.net/daiyudong2020/article/details/51707823)
### 终止
- windows中方法上： [分析进程、线程的终止](https://blog.csdn.net/wangfei8348/article/details/51452347)
- Linux中，终止的细节：
    - 进程退出会通知父进程去回收资源
    - 线程退出只有一个线程栈要回收 
[待补充...](https://www.zhihu.com/question/430128909)


### 多线程和多进程的选择

- 多进程
    - 背景：为了更充分利用CPU资源
    - 优点：编程、调试简单，可靠性较高
    - 缺点：创建、销毁、切换速度慢，内存、资源占用大
- 多线程
    - 背景:解决多线程页表开销以及TLB失效的问题
    - 优点:创建、销毁、切换速度快，内存、资源占用小
    - 缺点：编程、调试复杂，可靠性较差
- 选择or总结
    - 要频繁创建销毁or 大量计算：线程
    - 强相关：线程，弱相关：进程
    - 可能要扩展到多机分布的用进程，多核分布的用线程
[多线程还是多进程的选择及区别](https://blog.csdn.net/lishenglong666/article/details/8557215)
    

### IPC
- 消息传递
    - pipe
        - shell中的 '|'
        - 父子进程之间的由pipe函数创建的fd[2],fd[0]读，fd[1]写，都是单向的
        - 实质是一个内核缓冲区
    - FIFO
        - 背景:因为上面的pipe没有名字，所以只能用在有亲缘关系的两个进程当中，因为每个fifo有路径名与之对应，
          所以允许无亲缘关系的进程访问
        - mkfifo(const char *pathname,mode_t mode)//pathname是一个普通的Unix路径名
        - 只能读or只来写
    - 消息队列
        - 背景:解决了FIFO中，要写入的进程在写入前必须等待有读进程在管道上读才能写入从而阻塞的问题
        - 缺点:仍然有消息最大长度限制的问题
        - POSIX
        - System V
- 同步
    - 互斥锁，条件变量
        - 背景:为了允许多个线程或进程之间共享数据，同步是必要的
            - 通常是用来同步一个进程内的多个线程
            - 如果互斥锁和条件变量存放在多个进程的共享内存区中，那么它就可以用来进程间同步
    - 读写锁
        - 背景:在读多写少情况下较互斥锁条件变量更优
    - 信号量:
        - 背景:进程间or线程间同步原语,用于共享资源的同步访问 参考[semaphore和mutex的区别？-知乎](https://www.zhihu.com/question/47704079)
            - 互斥锁一般是锁住资源的概念，管理的是资源的**所有权信**，只有上锁人才能解开
            - 信号量管理的是资源的数量
        - POSIX
        - System V
- 共享内存
    - 背景: 是IPC方式中最快的，共享地址空间之后，就不涉及内核，但是却需要同步手段
        - 不涉及内核:进程不在需要任何设计内核的系统调用来彼此传递数据
    - mmap
    - POSIX
    - System V 
    
- Unix Socket
    - 背景：
        - 比单机上的TCP套接字快出一倍
            - 单机进程间通信效率优于网络套接字，因为仅仅进行数据复制，不会添加删除报头，计算校验和等等可靠性保证
        - 可用于单机内不同进程传递文件描述符
        - 用户凭证交给服务器(用户ID，组ID)，这提供了额外的安全检查措施

