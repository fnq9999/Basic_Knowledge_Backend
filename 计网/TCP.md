TCP 介绍
=================



### TCP 概念<br>
- TCP 特点
  - 面向连接
  - 点对点通信
  - 提供可靠交付
  - 全双工通信
  - 面向字节流
    - 将从应用进程收到的数据块都看成是字节流
- TCP可靠性
  - TCP提供可靠交付的服务：
    - 无差错：校验和机制，有差错直接将该报文丢弃，其他什么也不做。
    - 不丢失：累积确认和超时重传
    - 不重复：序号
    - 按序号到达：序号
  
  - 滑动窗口
  - 超时重传
    - RTT：加权平均来计算
    - RTO：由上面的RTT+4RTT_D
    - RTT_D：RTT偏差的加权平均
  - SACK
    - 指明SACK需要1字节，说明SACK选项长度需要1字节
    - 一个段需要两个数据，每个数据4字节。
    - 会在TCP的首部开销很大

### 三报文握手<br>
  - 目的
    - 确知对方存在
    - 允许双方协商参数
    - 对运输实体资源进行分配
  - 三次的原因：
    - 应该是4次才能双方同时建立ISN，但是中间的那两次可以合并变为1次
      - ISN ：初始序号
        - 随机的原因:1.防止被旧连接中的报文干扰，2.防止被黑客猜到进行攻击。
  - 建立连接之后，客户端发生故障怎么办：
    - TCP还设有一个保活计时器，显然，客户端如果出现故障，服务器不能一直等下去，白白浪费资源。服务器每收到一次客户端的请求后都会重新复位这个计时器，时间通常是设置为2小时，若两小时还没有收到客户端的任何数据，服务器就会发送一个探测报文段，以后每隔75秒钟发送一次。若一连发送10个探测报文仍然没反应，服务器就认为客户端出了故障，接着就关闭连接。
  - 四次的原因：
    - 三次握手中合并的两次，如果被动断开方没有数据要发，那直接三次。
    

<img src="https://raw.githubusercontent.com/fnq9999/Basic_Knowledge_Backend/master/%E8%AE%A1%E7%BD%91/image/%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B.png" width="50%" /><br>


<img src="https://raw.githubusercontent.com/fnq9999/Basic_Knowledge_Backend/master/%E8%AE%A1%E7%BD%91/image/%E5%9B%9B%E6%AC%A1%E6%8F%A1%E6%89%8B.png" width="50%" /><br>

  - close_wait原因
    - 此时TCP服务器进程通知高层应用进程，A->B方向上连接断开
    - 若B->A发数据，A仍要接受数据。
    - 当B都准备好了，向A发送FIN时，该状态结束

  - 最后等待2MSL的时间：
    - 保证A发送的最后一个ACK到达B
    - 防止已经失效的连接请求报文段出现在本连接中，保证下一个新的连接中不会出现这种就得连接请求报文段。
    



### TCP 滑动窗口<br>
- 可靠传输
  - 以字节为单位
  - 以报文形式发送
  - 三个指针  p1 p2 p3 
    - p1 滑动窗口开始节点
    - p2 未发送开始点
    - p3 窗口外第一点
  - 确认
    - 双方同时通信可采用捎带确认的方式
    - 延迟确认不允许超过0.5s,超长报文应该及时确认
    - 发送方收到确认之后，调整滑动窗口，再进行发送
- 流量控制
  - 通过确认报文中的 rwnd来确定。
  - 零窗口时死锁问题
    - 若接受方修改零窗口的报文丢失了，会出现死锁
    - 发送方在接受到零窗口时，开启一个持续定时器，
    - 时间到了发送零窗口探测报文。

### TCP 拥塞控制<br>
  - 概念Reno
    - 这里控制的窗口的单位其实是字节
    - 这里每次增大的1个单位原本是 MSS，
    - 但实际操作中，每次ACK都要增大一点，将原本窗口内都到达后一次增加的，进行拆分。
    - Increment = MSS x (MSS/CongestionWindow)
      CongestionWindow += Increment
  - 慢开始
    - 乘法增大
  - 拥塞避免
    - 加法增大
  - 快重传
    - 要求接受放受到报文就立刻确认，乱序的也要进行确认。
    - 当发送方收到三个重复的确认，立刻重发
  - 快恢复
    - ssthresh 变为拥塞发生时的一般，
    - cwnd变为ssthresh
- BBR

### TCP 常见面试题<br>
- TCP常见面试题
  - 为什么三次，为什么四次
  - 三次握手过程中，可以携带数据吗
  - 已经建立了连接，客户端出现故障怎么办
  - 2MSL原因
  - SYN洪水攻击原理
  - RFC793明确规定，除了第一个握手报文SYN除外，其它所有报文必须将ACK = 1，RFC规定的背后肯定有合理性的一面，能否深究一下原因？
    -TCP作为一个可靠传输协议，其可靠性就是依赖于收到对方的数据，ACK对方，这样对方就可以释放缓存的数据，因为对方确信数据已经被接收到了。

但TCP报文是在IP网络上传输，丢包是家常便饭，接收方要抓住一切的机会，把消息告诉发送方。最方便的方式就是，任何我方发送的TCP报文，都要捎带着ACK状态位。
  - ISN定义,ISN随机作用
    - 发送方字节数据编号原点
  - ACK 状态位能够独立承担消息传递任务
  
  
  
  
 <br>
[车小胖的回答](https://mp.weixin.qq.com/s/S1mv8AE_pQz3uHjRGS7tWg)



