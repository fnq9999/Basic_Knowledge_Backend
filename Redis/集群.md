集群
======

### 基本概念

- 集群：
- 分片：分slot
- 主从:
- 哨兵


### 主从复制原理
- 基本概念
    - 赋值积压缓冲区 
      - ![](.集群_images/637e352d.png)
      - 这个数据是环形的，如果设置过小，那么buffer覆盖，全量同步之后，又发生覆盖
        又要同步，造成死循环
    - 主从服务器赋值偏移量offset
        - mas维护多个 ind
        - sla维护一个
        
- 基本过程
    - 主从连接正常时进行简单的命令传播，维持着心跳
    - 主从网络中断时，从连接上之后，尝试同步，只获取断开连接期间丢失的命令流
    - 如果无法进行部分重同步就进行全量同步
    
- 全量同步：一般用于初次复制的场景
  - 首先master将RDB同步给slave
  - 同步期间master将所有写入操作记录到buffer中
  - slave加载完成后，通过偏移量将该期间master写入的值同步到slave 
- 部分同步:处理主从复制中网络原因造成的断线，当slave和master再次连接之后，
补发丢失的数据,避免全量同步开销。
    - 断线期间mas将写指令都写入到缓冲区
    - 从机不断尝试重连，直到成功
    - 从机发送偏移量给mas
    - mas比较offset是否还在buf,如果不在buf里则执行全量同步
    - 执行部分同步，同步增量数据



## 集群演变过程 
- 参考:
    - [redis集群演变（单机架构、主从架构、哨兵架构、redis-cluster架构）](https://www.programminghunter.com/article/7837392418/)
    - [Redis 集群架构 ](https://www.cnblogs.com/crazymakercircle/p/14282108.html)
- 单节点
  - 优点:就是redis的优点
  - 缺点：
    - 没有高可用,对于redis实例压力过大
    - 持久化:运行过程当中，磁盘损坏了，数据永远无法恢复
- 主从
    - 优点:
      - 读写分离，大量读操作现在到了slave身上了
      - 主从都做了持久化之后，一台磁盘坏了，另一台还能工作
    - 缺点:
        - 主服务器挂了，必须手动设置一个新的master服务器
- 哨兵
  - 特点:一个or读个组成的sentinel系统，监控多个主服务器以及所有主服务器的从服务器，
    被监视的主服务器下线时，自动将下线的主服务器的从服务器当中某个升级为主，然后新的主代理旧主接受请求命令
  - 优点:
    - 包含了所有主从的优点
    - 主服务挂掉，不需要人工介入，哨兵可以把从服务变为主服务
- 缺点:
    - 只有一个master的结构不可靠
    - 每台机器都保存全量数据，再做主从恢复时，耗时过长。

- 集群
    - 背景:解决单机redis容量有限问题，将数据按照一定规则分配给多台机器
    - 方案
      - 客户端分片
      - 代理分片  ：中心化集群方案
        - codis
        - Twemproxy  
      - 服务端分片
        - 一致性hash
        - redis cluster
  
### 客户端分片
- 特点：客户端通过固定的Hash算法，针对不同的key计算对应的Hash值，然后对不同的Redis节点进行读写，
  只要业务开发人员简单评估请求量数据量，让DBA人员部署即可
- 优点：业务方部署非常方便
- 缺点：
    - 需要业务方自己路由规则代码
    - 随着业务量变化，数据迁移不方便，从而引出了**一致性hash**

### 一致性hash
- ![](.集群_images/7cfceaec.png)
- 问题
    - 数据倾斜，有的节点分配到的Key多，有的key少
        - 解决:采用在hash环上插入虚节点的方案，更均匀分配key
    - 容错性和可扩展性
        - 相对较好，原因:在hash环上增删一个节点，影响的只有其中一个节点，影响比较小

### Redis Cluster 参考[Redis 集群教程](http://www.redis.cn/topics/cluster-tutorial.html)
- hash 槽
  - 16384个槽
  - 每个 key 通过 CRC16 校验后对 16384 取模来决定放置哪个槽
- 特点：
    - 无中心化，无Proxy，(客户端redis的sdk当中维护了路由逻辑)
    - 节点之间，可动态调整数据分布  
    - 可扩展性，可扩展到1000节点
    - 高可用，部分节点不可用时，集群仍可用  
    - 节点接gossip协议通信，投票机制完成选slave->master
- 缺点：
    - 非强一致性,会出现数据丢失
    - 资源隔离性较差，容易出现相互影响的情况。
    
### Codis


