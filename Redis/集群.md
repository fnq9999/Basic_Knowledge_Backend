集群
======

### 基本概念

- 集群：
- 分片：分slot
- 主从:
- 哨兵


### 主从复制原理
- 基本概念
    - 赋值积压缓冲区 
      - ![](.集群_images/637e352d.png)
      - 这个数据是环形的，如果设置过小，那么buffer覆盖，全量同步之后，又发生覆盖
        又要同步，造成死循环
    - 主从服务器赋值偏移量offset
        - mas维护多个 ind
        - sla维护一个
        
- 基本过程
    - 主从连接正常时进行简单的命令传播，维持着心跳
    - 主从网络中断时，从连接上之后，尝试同步，只获取断开连接期间丢失的命令流
    - 如果无法进行部分重同步就进行全量同步
    
- 全量同步：一般用于初次复制的场景
  - 首先master将RDB同步给slave
  - 同步期间master将所有写入操作记录到buffer中
  - slave加载完成后，通过偏移量将该期间master写入的值同步到slave 
- 部分同步:处理主从复制中网络原因造成的断线，当slave和master再次连接之后，
补发丢失的数据,避免全量同步开销。
    - 断线期间mas将写指令都写入到缓冲区
    - 从机不断尝试重连，直到成功
    - 从机发送偏移量给mas
    - mas比较offset是否还在buf,如果不在buf里则执行全量同步
    - 执行部分同步，同步增量数据



### 集群演变过程
- 参考:[redis集群演变（单机架构、主从架构、哨兵架构、redis-cluster架构）](https://www.programminghunter.com/article/7837392418/)
- 单节点
  - 优点:就是redis的优点
  - 缺点：
    - 没有高可用,对于redis实例压力过大
    - 持久化:运行过程当中，磁盘损坏了，数据永远无法恢复
- 主从
    - 优点:
      - 读写分离，大量读操作现在到了slave身上了
      - 主从都做了持久化之后，一台磁盘坏了，另一台还能工作
    - 缺点:
        - 主服务器挂了，必须手动设置一个新的master服务器
- 哨兵
  - 优点:
    - 包含了所有主从的优点
    - 主服务挂掉，不需要人工介入，哨兵可以把从服务变为主服务
    - 缺点:
        - 只有一个master的结构不可靠
        - 每台机器都保存全量数据，再做主从回复时，耗时过长。
    
- 分片
    - 客户端分片
    - 服务端分片
    





### Redis Cluster



### Codis


